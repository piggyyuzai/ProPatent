import{h as J,r as i,p as R,c as w,b as s,w as M,j as T,t as b,g as _,q as z,v as W,f as x,a as V,s as E,l as X,o as k}from"./index-Blb7us2k.js";import{_ as Y}from"./_plugin-vue_export-helper-DlAUqK2U.js";const $={class:"login-container"},q={class:"input-group",id:"usertel-input"},F={key:0,class:"error"},G={class:"input-group",id:"captcha-input"},H={style:{display:"flex","align-items":"center","justify-content":"center"}},K={key:0,class:"error"},Q={class:"input-group",id:"telecaptcha-input"},tt={style:{display:"flex","align-items":"center","justify-content":"center"}},et=["disabled"],at={key:0,class:"error"},ot={class:"input-group",id:"agreement-input",style:{"font-size":"14px"}},st={__name:"login",setup(nt){J(()=>{U(),L()});const c=i(""),g=i(""),I=i(""),h=i(""),y=i(""),a=R({usertel:"",telecaptcha:"",captcha:""}),C=i(!1),O=async()=>{if(a.usertel="",a.telecaptcha="",a.captcha="",c.value?/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(c.value)||(a.usertel="* 邮箱格式不正确",l("usertel-input")):(a.usertel="* 邮箱不能为空",l("usertel-input")),!g.value)a.telecaptcha="* 邮箱验证码不能为空",l("telecaptcha-input");else if(g.value!==I.value){a.telecaptcha="* 邮箱验证码错误",l("telecaptcha-input");return}if(h.value?h.value!==y.value&&(a.captcha="* 验证码错误",l("captcha-input")):(a.captcha="* 验证码不能为空",l("captcha-input")),!C.value){l("agreement-input");return}if(!a.usertel&&!a.telecaptcha&&!a.captcha)try{const e=await fetch("/api/users/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mail:c.value})}),t=await e.json();if(e.ok){window.localStorage.setItem("isLoggedIn","true"),window.localStorage.setItem("token",t.token);const o=t.user;window.localStorage.user=JSON.stringify({id:o.id,name:o.name,mail:o.mail,avatar:o.avatar,membershipExpiry:o.membership_expiry?new Date(o.membership_expiry).toLocaleDateString():"暂未开通"}),window.history.back()}else console.error("登录失败:",t.message),alert(t.message)}catch(e){console.error("网络错误:",e),alert("登录过程中发生错误，请重试。")}},P=async()=>{if(a.usertel="",a.telecaptcha="",a.captcha="",c.value?/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(c.value)||(a.usertel="* 邮箱格式不正确",l("usertel-input")):(a.usertel="* 邮箱不能为空",l("usertel-input")),h.value?h.value!==y.value&&(a.captcha="* 验证码错误",l("captcha-input")):(a.captcha="* 验证码不能为空",l("captcha-input")),!m.value&&!a.usertel&&!a.telecaptcha&&!a.captcha){const e=Math.floor(Date.now()/1e3)+60;localStorage.setItem("telecaptchaEndTime",e),d.value=60,m.value=!0,j();try{const t=await fetch("/api/users/send-verification-code",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:c.value})}),o=await t.json();t.ok?(I.value=o.verificationCode,alert(o.message)):(console.error("发送验证码失败:",o.message),alert(o.message))}catch(t){console.error("网络错误:",t),alert("发送验证码过程中发生错误，请重试。")}}},A=()=>"#"+Array.from({length:6},()=>"0123456789ABCDEF"[Math.floor(Math.random()*16)]).join(""),Z=(e,t,o)=>{for(let p=0;p<4;p++){if(e.strokeStyle=A(),e.lineWidth=Math.random()*3,e.beginPath(),Math.random()<.5){const r=Math.random()*t,u=Math.random()*o;for(let v=r;v<r+40;v+=5){const S=u+(Math.random()*10-5);e.lineTo(v,S)}}else{const r=Math.random()*t,u=Math.random()*o,v=r+(Math.random()*2-1)*40,S=u+(Math.random()*2-1)*40;e.moveTo(r,u),e.lineTo(v,S)}e.stroke()}},B=(e,t,o)=>{const p=Math.floor(t*o*.03);for(let f=0;f<p;f++){const r=Math.random()*t,u=Math.random()*o;e.fillStyle="#000000",e.fillRect(r,u,.8,.8)}},D=i(null),L=()=>{const e=D.value,t=e.getContext("2d"),o=4;y.value="",t.clearRect(0,0,e.width,e.height),Z(t,e.width,e.height),B(t,e.width,e.height);for(let n=0;n<o;n++){const p=Math.random().toString(36).charAt(2);y.value+=p;const f=Math.random()*10-5,r=Math.random()*10-5,u=(Math.random()-.5)*Math.PI/6;t.save(),t.translate(10+n*20+f,30+r),t.rotate(u),t.fillStyle=A(),t.font="bold 30px Arial",t.fillText(p,0,0),t.restore()}},d=i(60),m=i(!1);let N=null;const U=()=>{const e=localStorage.getItem("telecaptchaEndTime");if(e){const t=Math.max(0,Math.floor(parseInt(e)-Math.floor(Date.now()/1e3)));t>0&&(m.value=!0,d.value=t,j())}},j=()=>{N=setInterval(()=>{d.value=Math.max(0,Math.floor(d.value)-1),d.value<=0&&(clearInterval(N),m.value=!1,localStorage.removeItem("telecaptchaEndTime"))},1e3)};function l(e){const t=document.getElementById(e);t.classList.add("shake"),setTimeout(()=>{t.classList.remove("shake")},900)}return(e,t)=>{const o=X("router-link");return k(),w("div",$,[t[12]||(t[12]=s("h2",{style:{color:"#4d70ff"}},"登录ProPatent",-1)),s("form",{onSubmit:z(O,["prevent"])},[s("div",q,[t[4]||(t[4]=s("div",{class:"input-label"},"邮箱",-1)),M(s("input",{type:"text",id:"usertel","onUpdate:modelValue":t[0]||(t[0]=n=>c.value=n),placeholder:"未注册邮箱将自动注册"},null,512),[[T,c.value]]),a.usertel?(k(),w("p",F,b(a.usertel),1)):_("",!0)]),s("div",G,[t[5]||(t[5]=s("div",{class:"input-label"},"验证码",-1)),s("div",H,[M(s("input",{type:"text",id:"captcha","onUpdate:modelValue":t[1]||(t[1]=n=>h.value=n),placeholder:"请输入验证码",style:{width:"150px"}},null,512),[[T,h.value]]),s("canvas",{ref_key:"captchaCanvas",ref:D,width:"100",height:"36",onClick:L},null,512)]),a.captcha?(k(),w("p",K,b(a.captcha),1)):_("",!0)]),s("div",Q,[t[6]||(t[6]=s("div",{class:"input-label"},"邮箱验证码",-1)),s("div",tt,[M(s("input",{type:"text",id:"telecaptcha","onUpdate:modelValue":t[2]||(t[2]=n=>g.value=n),placeholder:"请输入验证码",style:{width:"150px"}},null,512),[[T,g.value]]),s("button",{class:"resend-btn",onClick:z(P,["stop","prevent"]),disabled:m.value},b(m.value?`剩余${d.value}秒`:d.value===0?"再次发送":"发送验证码"),9,et)]),a.telecaptcha?(k(),w("p",at,b(a.telecaptcha),1)):_("",!0)]),s("div",ot,[M(s("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=n=>C.value=n),style:{width:"14px"}},null,512),[[W,C.value]]),t[9]||(t[9]=x(" 我已同意 ")),V(o,{to:"",style:{color:"#4d70ff","font-weight":"bold",cursor:"pointer"}},{default:E(()=>t[7]||(t[7]=[x("用户使用协议")])),_:1}),t[10]||(t[10]=x(" 和 ")),V(o,{to:"",style:{color:"#4d70ff","font-weight":"bold",cursor:"pointer"}},{default:E(()=>t[8]||(t[8]=[x("隐私政策")])),_:1})]),t[11]||(t[11]=s("button",{class:"login-btn",type:"submit"},"登录",-1))],32)])}}},it=Y(st,[["__scopeId","data-v-d137b62a"]]);export{it as default};
